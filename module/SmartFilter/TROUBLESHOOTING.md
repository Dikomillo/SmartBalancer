# SmartFilter: диагностика проблемы «Поиск не дал результатов»

Эта памятка поможет понять, почему SmartFilter возвращает сообщение «Контент не найден», и какие шаги предпринять для исправления ситуации. SmartFilter работает как агрегатор поверх других онлайн-провайдеров Lampac, поэтому успешный поиск зависит от их доступности и корректности ответа.

## 1. Провайдеры не вернули данные
* Если после агрегации список данных пустой, контроллер сразу возвращает ошибку. 【F:module/SmartFilter/SmartFilterController.cs†L75-L118】
* SmartFilter собирает актуальный список провайдеров через `/lite/events`. Если запрос ничего не вернул или завершился ошибкой, агрегатор не сможет найти контент. 【F:module/SmartFilter/SmartFilterEngine.cs†L119-L173】

**Что сделать:**
1. Убедиться, что остальные онлайн-модули Lampac включены и корректно отвечают на запросы `/lite/<module>?rjson=true`.
2. Проверить доступность эндпоинта `/lite/events` и отсутствие ошибок в логах SmartFilter.

## 2. Провайдеры отфильтрованы настройками
SmartFilter может исключить часть источников до отправки запросов:

* Список `excludeProviders` исключает указанные модули целиком.
* Список `includeOnlyProviders`, если не пуст, оставляет только перечисленные модули.
* Сам SmartFilter никогда не запрашивает собственный агрегатор «SmartFilter Aggregator».
* Для несерийного контента (фильмы) автоматически отбрасываются «аниме»-провайдеры.

Все эти проверки выполняются при подготовке списка активных источников. 【F:module/SmartFilter/SmartFilterEngine.cs†L133-L157】

**Что сделать:**
1. Проверить файл `module/SmartFilter/SmartFilter.conf` и убедиться, что нужные провайдеры не попали в `excludeProviders` или что список `includeOnlyProviders` не слишком узкий. 【F:module/SmartFilter/SmartFilter.conf†L1-L11】
2. При поиске фильмов учитывать, что аниме-провайдеры будут исключены автоматически.

## 3. Ошибки запросов к провайдерам
Для каждого провайдера SmartFilter добавляет параметр `rjson=true` и ждет JSON-ответ. HTML-страницы (например, страница ошибки от Cloudflare) отбрасываются. 【F:module/SmartFilter/SmartFilterEngine.cs†L189-L293】

Если провайдер не успевает ответить, `HttpClient` прерывает запрос по таймауту, после чего попытка может повториться (если включен `enableRetry`). 【F:module/SmartFilter/SmartFilterEngine.cs†L197-L228】

**Что сделать:**
1. Увеличить `requestTimeoutSeconds` или `maxRetryAttempts` в конфигурации, если внешние источники отвечают медленно. 【F:module/SmartFilter/SmartFilter.conf†L1-L11】
2. Проверить, что конечные провайдеры действительно поддерживают `rjson=true` и выдают валидный JSON.

## 4. Мониторинг прогресса и логирование
* Любой запрос к SmartFilter получает `progressKey`, который можно опросить через `/lite/smartfilter/progress?key=<progressKey>` для диагностики статуса каждого провайдера. 【F:module/SmartFilter/SmartFilterController.cs†L70-L115】【F:module/SmartFilter/SmartFilterProgress.cs†L13-L120】
* При старте модуль печатает активную конфигурацию и готовность к работе, что полезно для проверки настроек. 【F:module/SmartFilter/ModInit.cs†L63-L105】

**Что сделать:**
1. Включить `detailedLogging` в конфигурации, чтобы получать расширенную информацию в логах.
2. При необходимости удалить `module/SmartFilter/SmartFilter.current.conf` — он обновится автоматически и поможет убедиться, что конфигурация загружена.

## 5. Общие рекомендации
* Убедитесь, что параметр `enable` в конфигурации SmartFilter установлен в `true`, иначе модуль не будет работать. 【F:module/SmartFilter/SmartFilter.conf†L1-L11】
* Храните число параллельных запросов (`maxParallelRequests`) в разумных пределах, чтобы не перегружать сервер или провайдеры. 【F:module/SmartFilter/SmartFilter.conf†L1-L11】
* Если после всех проверок результат по-прежнему пустой, попробуйте повторить поиск с более точными идентификаторами (IMDB, Кинопоиск) — они передаются каждому провайдеру вместе с запросом. 【F:module/SmartFilter/SmartFilterEngine.cs†L186-L217】【F:module/SmartFilter/SmartFilterEngine.cs†L373-L425】

Следуя этим шагам, можно локализовать причину отсутствия результатов и вернуть SmartFilter к штатной работе.
