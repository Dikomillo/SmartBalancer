# Codex Agent Rules ‚Äî Lampac Project

**–ü–∏—à–∏ –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.** 

–û—Å–Ω–æ–≤–Ω–æ–π –ø–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
- https://deepwiki.com/immisterio/Lampac - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è 
- https://github.com/immisterio/Lampac/main/ - –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–µ –º–æ–π)



## üìò –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞

- –≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏–∑ DeepWiki —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è `immisterio/Lampac`.
- https://deepwiki.com/immisterio/Lampac - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è 
- –í—Å–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏ –∫–æ–¥–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–∞ DeepWiki**.
- –ü–µ—Ä–µ–¥ –ª—é–±—ã–º –∫–æ–¥–æ–º –∞–≥–µ–Ω—Ç –æ–±—è–∑–∞–Ω –ø–æ–Ω—è—Ç—å –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —á—Ç–æ –ø–æ–Ω—è–ª –≤—Å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.
- –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å < 99 % ‚Äî –∫–æ–¥ –Ω–µ –ø–∏—Å–∞—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è.

---

## üß≠ –≠—Ç–∞–ø 1 ‚Äî –ê–Ω–∞–ª–∏–∑
   –ü—Ä–æ—á–∏—Ç–∞—Ç—å –º–∏–Ω–∏–º—É–º:
   - `https://deepwiki.com/immisterio/Lampac`
   - `https://github.com/immisterio/Lampac/main/`
   - `—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≥–∞–π–¥—ã/–º–æ–¥—É–ª–∏`  


---

## üß† –≠—Ç–∞–ø 2 ‚Äî –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- –°–æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
- –ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã/—Ç–æ—á–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
- –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–∫—Ä—ã—Ç—ã.

‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≠—Ç–∞–ø—É 1.

---

## üõ† –≠—Ç–∞–ø 3 ‚Äî –ö–æ–¥–∏–Ω–≥
- –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ —Å–≤–µ—Ä—è—Ç—å—Å—è —Å DeepWiki –∏ GitHub Lampac
- –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ  –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç—ã –Ω–µ –Ω—É–∂–Ω—ã.
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞—Ç—å API; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã.
- –°–ª–µ–¥–æ–≤–∞—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏—è–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∏–º–µ–Ω–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è Lampa).
- –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–µ—Ä–∫–∞ —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏.
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- –ù–µ –≤—ã–¥—É–º–∞—Ç—å –Ω–∏—á–µ–≥–æ, –ª—É—á—à–µ —Å–ø—Ä–æ—Å–∏—Ç—å –∏ –ø–æ—Ç–æ–º –∫–æ–¥–∏—Ç—å.
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞, –∫–æ—Ä—Ç–∫–æ, –ø–æ–Ω—è—Ç–Ω–æ, —Ä–∞—Å—à–∏—Ä—è–µ–º–æ, —á–∏—Ç–∞–µ–º–æ, –ª–µ–≥–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥—É–º–∞–≤–∞–µ–º –≤—Å–µ —á—Ç–æ –±—ã –∫–æ–¥ –Ω–µ –ª–æ–º–∞–ª—Å—è –ø—Ä–∏ –º–∞–ª–µ–π—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.
---

## üß™ –≠—Ç–∞–ø 4 ‚Äî –¢–µ—Å—Ç—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –Ω–µ –Ω—É–∂–Ω—ã

---

## ü§ñ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—Å–∞—Ç—å –∫–æ–¥, –Ω–µ –ø–æ–Ω—è–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.
- –í—Å–µ–≥–¥–∞ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑ DeepWiki.
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —ç—Ç–∞–ø –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π.
- –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö ‚Äî **–≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ –∫–æ–¥**.

# README: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ –¥–ª—è Lampac

## –û–±–∑–æ—Ä

–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –≤ Lampac ‚Äî —ç—Ç–æ –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏—Ö –æ—Ç–≤–µ—Ç—ã –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –µ–¥–∏–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ñ–∏–ª—å–º—ã, —Å–µ—Ä–∏–∞–ª—ã, –∞–Ω–∏–º–µ).

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** (`YourAggregatorController.cs`) - –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `BaseOnlineController` [1](#5-0) 
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** (`YourAggregatorSettings.cs`) - –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `BaseSettings`
3. **–ú–∞–Ω–∏—Ñ–µ—Å—Ç** (`manifest.json`) - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è
4. **–ú–µ—Ç–æ–¥—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** - `Invoke()` –∏ `InvokeAsync()` –¥–ª—è `/lite/events` [2](#5-1) 

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
module/YourAggregator/
‚îú‚îÄ‚îÄ manifest.json          # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è
‚îú‚îÄ‚îÄ YourAggregatorController.cs  # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îú‚îÄ‚îÄ YourAggregatorSettings.cs    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îî‚îÄ‚îÄ OnlineApi.cs          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å /lite/events
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ú–∞–Ω–∏—Ñ–µ—Å—Ç (manifest.json)

```json
{
  "enable": true,
  "version": 3,
  "dll": "YourAggregator",
  "namespace": "YourAggregator",
  "initspace": "ModInit",
  "online": "YourAggregatorController",
  "name": "YourAggregator",
  "index": 5
}
```

### 2. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

**–ú–∞—Ä—à—Ä—É—Ç:** `/lite/youraggregator` [3](#5-2) 

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `id`, `imdb_id`, `kinopoisk_id` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
- `title`, `original_title` - –Ω–∞–∑–≤–∞–Ω–∏—è
- `s` - —Å–µ–∑–æ–Ω (`-1` = –≤—ã–±–æ—Ä —Å–µ–∑–æ–Ω–∞, `1+` = –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ–∑–æ–Ω) [4](#5-3) 
- `t` - –æ–∑–≤—É—á–∫–∞ (ID –ø–µ—Ä–µ–≤–æ–¥–∞) [5](#5-4) 
- `rjson` - —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ (JSON/HTML)

**–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞:**

```csharp
[Route("lite/youraggregator")]
public class YourAggregatorController : BaseOnlineController
{
    [HttpGet]
    public async Task<ActionResult> Index(long id, string imdb_id, 
        long kinopoisk_id, string title, int s = -1, string t = null, bool rjson = false)
    {
        var init = await loadKit(AppInit.conf.YourAggregator);
        if (await IsBadInitialization(init))
            return badInitMsg;

        // 1. –û–ø—Ä–æ—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
        var results = await QueryProviders(id, imdb_id, kinopoisk_id, title);
        
        // 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
        return s == -1 ? RenderSeasons(results, rjson) : 
                         RenderEpisodes(results, s, t, rjson);
    }
}
```

### 3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–ü–æ–ª—É—á–µ–Ω–∏–µ URL –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤:** [6](#5-5) 

```csharp
async Task<List<string>> QueryProviders(long id, string imdb_id, long kinopoisk_id, string title)
{
    var urls = new List<string>();
    var args = new OnlineEventsModel(imdb_id, kinopoisk_id.ToString(), title);
    
    // –í—ã–∑–æ–≤ Invoke() –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
    foreach (var provider in OnlineModuleEntry.onlineModulesCache)
    {
        if (provider.Invoke != null)
        {
            var results = provider.Invoke(HttpContext, memoryCache, requestInfo, host, args);
            urls.AddRange(results.Select(r => r.url));
        }
    }
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å
    var responses = await Task.WhenAll(
        urls.Select(url => FetchAndParse(url))
    );
    
    return responses.Where(r => r != null).ToList();
}
```

### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `InvokeCache` —Å —Å–µ–º–∞—Ñ–æ—Ä–∞–º–∏:** [7](#5-6) 

```csharp
var cache = await InvokeCache<List<Result>>(
    $"youraggregator:{id}:{imdb_id}:{kinopoisk_id}",
    cacheTime(20, init: init),  // 20 –º–∏–Ω—É—Ç
    proxyManager,
    async res => {
        var data = await QueryProviders(...);
        if (data == null || data.Count == 0)
            return res.Fail("no data");
        return data;
    }
);
```

**–í—Ä–µ–º—è –∫—ç—à–∞ –ø–æ —Ç–∏–ø—É –¥–æ—Å—Ç—É–ø–∞:**
- `multiaccess` - –º–∏–Ω—É—Ç—ã
- `home` - —á–∞—Å—ã  
- `mikrotik` - –¥–Ω–∏

### 5. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞

#### –§–∏–ª—å–º—ã (MovieTpl) [8](#5-7) 

```csharp
var mtpl = new MovieTpl(title, original_title);
foreach (var item in results)
{
    mtpl.Append(
        item.voice,           // –ù–∞–∑–≤–∞–Ω–∏–µ –æ–∑–≤—É—á–∫–∏
        item.link,            // –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
        quality: item.quality // –ö–∞—á–µ—Å—Ç–≤–æ (1080p, 720p)
    );
}
return ContentTo(rjson ? mtpl.ToJson() : mtpl.ToHtml());
```

#### –°–µ—Ä–∏–∞–ª—ã - –°–µ–∑–æ–Ω—ã (SeasonTpl) [9](#5-8) 

```csharp
if (s == -1)
{
    var tpl = new SeasonTpl();
    var seasons = new HashSet<int>();
    
    foreach (var item in results)
    {
        if (!seasons.Contains(item.season))
        {
            seasons.Add(item.season);
            tpl.Append(
                $"{item.season} —Å–µ–∑–æ–Ω",
                $"{host}/lite/youraggregator?s={item.season}&...",
                item.season
            );
        }
    }
    return ContentTo(rjson ? tpl.ToJson() : tpl.ToHtml());
}
```

#### –°–µ—Ä–∏–∞–ª—ã - –û–∑–≤—É—á–∫–∏ (VoiceTpl) [10](#5-9) 

```csharp
var vtpl = new VoiceTpl();
var voices = new HashSet<string>();

foreach (var item in results.Where(r => r.season == s))
{
    if (!voices.Contains(item.voice))
    {
        voices.Add(item.voice);
        vtpl.Append(
            item.voice,
            t == item.voiceId,  // –ê–∫—Ç–∏–≤–Ω–∞—è –æ–∑–≤—É—á–∫–∞
            $"{host}/lite/youraggregator?s={s}&t={item.voiceId}&..."
        );
    }
}
```

#### –°–µ—Ä–∏–∞–ª—ã - –°–µ—Ä–∏–∏ (EpisodeTpl) [11](#5-10) 

```csharp
var etpl = new EpisodeTpl();
string sArhc = s.ToString();

foreach (var item in results.Where(r => r.season == s && r.voiceId == t))
{
    etpl.Append(
        $"{item.episode} —Å–µ—Ä–∏—è",  // –ù–∞–∑–≤–∞–Ω–∏–µ
        title,                     // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∞–ª–∞
        sArhc,                     // –°–µ–∑–æ–Ω –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
        item.episode.ToString(),   // –ù–æ–º–µ—Ä —Å–µ—Ä–∏–∏
        item.stream                // –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
    );
}

// –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥
return rjson ? etpl.ToJson(vtpl) : vtpl.ToHtml() + etpl.ToHtml();
```

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å /lite/events

**OnlineApi.cs:**

```csharp
public static List<(string name, string url, string plugin, int index)> Invoke(
    HttpContext httpContext,
    IMemoryCache memoryCache,
    RequestModel requestInfo,
    string host,
    OnlineEventsModel args)
{
    var url = $"{host}/lite/youraggregator?id={args.id}&imdb_id={args.imdb_id}&kinopoisk_id={args.kinopoisk_id}";
    return new List<(string,string,string,int)>
    {
        ("YourAggregator", url, "youraggregator", 0)
    };
}
```

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω—é–∞–Ω—Å—ã

### 1. –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç URL, –Ω–µ –¥–∞–Ω–Ω—ã–µ

–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –≤ `/lite/events` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç **—Å—Å—ã–ª–∫–∏** –Ω–∞ —Å–≤–æ–∏ endpoints, –∞ –Ω–µ –≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ. [6](#5-5)  –í–∞–º –Ω—É–∂–Ω–æ:
1. –ü–æ–ª—É—á–∏—Ç—å URL —á–µ—Ä–µ–∑ `Invoke()`
2. –°–¥–µ–ª–∞—Ç—å HTTP GET –∫ –∫–∞–∂–¥–æ–º—É URL
3. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç (HTML/JSON)

### 2. –°–µ–º–∞—Ñ–æ—Ä—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç cache stampede

`InvokeCache` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–ª—é—á–æ–º. [7](#5-6)  –ì–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∫—ç—à–∞.

### 3. RCH –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

–ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —Å VPS, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Remote Client Hub: [12](#5-11) 

```csharp
var rch = new RchClient(HttpContext, host, init, requestInfo);
if (rch.IsNotSupport("web", out string rch_error))
    return ShowError(rch_error);
```

### 4. –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞

–î–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫:
1. `s=-1` ‚Üí –°–µ–∑–æ–Ω—ã (SeasonTpl)
2. `s=1` ‚Üí –û–∑–≤—É—á–∫–∏ (VoiceTpl)  
3. `s=1&t=voice1` ‚Üí –°–µ—Ä–∏–∏ (EpisodeTpl)

### 5. –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ

–ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: [13](#5-12) 

### 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–û—à–∏–±–∫–∏ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –ª–æ–º–∞—Ç—å –≤–µ—Å—å –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä. [14](#5-13)  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `try-catch` –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö.

## –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ "YourAggregator" –≤ `/lite/events`
2. Lampac –≤—ã–∑—ã–≤–∞–µ—Ç `/lite/youraggregator?id=123&imdb_id=tt456`
3. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã —á–µ—Ä–µ–∑ –∏—Ö `Invoke()`
4. –ü–æ–ª—É—á–∞–µ—Ç URL: `["/lite/alloha?id=123", "/lite/rezka?id=123"]`
5. –î–µ–ª–∞–µ—Ç HTTP GET –∫ –∫–∞–∂–¥–æ–º—É URL –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
6. –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç—ã, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –æ–∑–≤—É—á–∫–∏/—Å–µ—Ä–∏–∏/–∫–∞—á–µ—Å—Ç–≤–æ
7. –§–æ—Ä–º–∏—Ä—É–µ—Ç `MovieTpl`/`SeasonTpl`/`EpisodeTpl`
8. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML/JSON —á–µ—Ä–µ–∑ `ContentTo()`

## –°—Å—ã–ª–∫–∏

- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤: `Online/Controllers/` [15](#5-14) 
- –®–∞–±–ª–æ–Ω—ã: `Shared/Models/Templates/`
- –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: `Shared/BaseOnlineController.cs`

Wiki pages you might want to explore:
- [Lampac Overview (immisterio/Lampac)](/wiki/immisterio/Lampac#1)
- [Content Aggregation System (immisterio/Lampac)](/wiki/immisterio/Lampac#6)
- [Remote Client Hub (RCH) System (immisterio/Lampac)](/wiki/immisterio/Lampac#8.3)

### Citations

**File:** Online/Controllers/Alloha.cs (L1-10)
```csharp
Ôªøusing Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Shared.Models.Online.Alloha;
using Shared.Models.Online.Settings;
using Shared.PlaywrightCore;

namespace Online.Controllers
{
    public class Alloha : BaseOnlineController
```

**File:** Online/Controllers/Alloha.cs (L36-36)
```csharp
        [Route("lite/alloha")]
```

**File:** Online/Controllers/Alloha.cs (L62-81)
```csharp
                #region –§–∏–ª—å–º
                var mtpl = new MovieTpl(title, original_title);
                bool directors_cut = data.Value<bool>("available_directors_cut");

                foreach (var translation in data.Value<JObject>("translation_iframe").ToObject<Dictionary<string, Dictionary<string, object>>>())
                {
                    string link = $"{host}/lite/alloha/video?t={translation.Key}&token_movie={result.data.Value<string>("token_movie")}" + defaultargs;
                    string streamlink = accsArgs($"{link.Replace("/video", "/video.m3u8")}&play=true");

                    bool uhd = false;
                    if (translation.Value.TryGetValue("uhd", out object _uhd))
                        uhd = _uhd.ToString().ToLower() == "true" && init.m4s;

                    if (directors_cut && translation.Key == "66")
                        mtpl.Append("–†–µ–∂–∏—Å—Å–µ—Ä—Å–∫–∞—è –≤–µ—Ä—Å–∏—è", $"{link}&directors_cut=true", "call", $"{streamlink}&directors_cut=true", voice_name: uhd ? "2160p" : translation.Value["quality"].ToString(), quality: uhd ? "2160p" : "");

                    mtpl.Append(translation.Value["name"].ToString(), link, "call", streamlink, voice_name: uhd ? "2160p" : translation.Value["quality"].ToString(), quality: uhd ? "2160p" : "");
                }

                return ContentTo(rjson ? mtpl.ToJson() : mtpl.ToHtml());
```

**File:** Online/OnlineApi.cs (L628-702)
```csharp

            #region modules
            OnlineModuleEntry.EnsureCache();

            if (OnlineModuleEntry.onlineModulesCache != null && OnlineModuleEntry.onlineModulesCache.Count > 0)
            {
                var args = new OnlineEventsModel(id, imdb_id, kinopoisk_id, title, original_title, original_language, year, source, rchtype, serial, life, islite, account_email, uid, token);

                foreach (var entry in OnlineModuleEntry.onlineModulesCache)
                {
                    try
                    {
                        #region version >= 3 methods
                        if (entry.Invoke != null)
                        {
                            try
                            {
                                var result = entry.Invoke(HttpContext, memoryCache, requestInfo, host, args);
                                if (result != null && result.Count > 0)
                                {
                                    foreach (var r in result)
                                        online.Add((null, r.name, r.url, r.plugin, r.index));
                                }
                            }
                            catch { }
                        }

                        if (entry.InvokeAsync != null)
                        {
                            try
                            {
                                var result = await entry.InvokeAsync(HttpContext, memoryCache, requestInfo, host, args);
                                if (result != null && result.Count > 0)
                                {
                                    foreach (var r in result)
                                        online.Add((null, r.name, r.url, r.plugin, r.index));
                                }
                            }
                            catch { }
                        }
                        #endregion

                        #region version < 3 legacy methods
                        if (entry.Events != null)
                        {
                            try
                            {
                                var result = entry.Events(host, id, imdb_id, kinopoisk_id, title, original_title, original_language, year, source, serial, account_email);
                                if (result != null && result.Count > 0)
                                {
                                    foreach (var r in result)
                                        online.Add((null, r.name, r.url, r.plugin, r.index));
                                }
                            }
                            catch { }
                        }

                        if (entry.EventsAsync != null)
                        {
                            try
                            {
                                var result = await entry.EventsAsync(HttpContext, memoryCache, host, id, imdb_id, kinopoisk_id, title, original_title, original_language, year, source, serial, account_email);
                                if (result != null && result.Count > 0)
                                {
                                    foreach (var r in result)
                                        online.Add((null, r.name, r.url, r.plugin, r.index));
                                }
                            }
                            catch { }
                        }
                        #endregion
                    }
                    catch (Exception ex) { Console.WriteLine($"Modules {entry.mod?.NamespacePath(entry.mod.online)}: {ex.Message}\n\n"); }
                }
            }
```

**File:** Online/OnlineApi.cs (L1230-1265)
```csharp
                            case "hydraflix":
                            case "movpi":
                            case "videasy":
                            case "vidlink":
                            case "autoembed":
                            case "veoveo":
                            case "vokino-vibix":
                            case "vokino-monframe":
                            case "vokino-remux":
                            case "vokino-ashdi":
                            case "vokino-hdvb":
                                quality = " ~ 1080p";
                                break;
                            case "voidboost":
                            case "animedia":
                            case "animevost":
                            case "animebesst":
                            case "kodik":
                            case "kinotochka":
                            case "rhs":
                                quality = " ~ 720p";
                                break;
                            case "kinokrad":
                            case "kinoprofi":
                            case "seasonvar":
                                quality = " - 480p";
                                break;
                            case "cdnmovies":
                                quality = " - 360p";
                                break;
                            default:
                                break;
                        }

                        if (balanser == "vokino")
                            quality = res.Contains("4K HDR") ? " - 4K HDR" : res.Contains("4K ") ? " - 4K" : quality;
```

**File:** Online/Controllers/VeoVeo.cs (L79-79)
```csharp
                    if (s == -1)
```

**File:** Online/Controllers/VeoVeo.cs (L81-94)
```csharp
                        var tpl = new SeasonTpl();
                        var hash = new HashSet<int>();

                        foreach (var item in cache.Value)
                        {
                            var season = item["season"].Value<int>("order");
                            if (hash.Contains(season))
                                continue;

                            hash.Add(season);
                            string link = $"{host}/lite/veoveo?rjson={rjson}&kinopoisk_id={kinopoisk_id}&imdb_id={imdb_id}&title={HttpUtility.UrlEncode(title)}&original_title={HttpUtility.UrlEncode(original_title)}&s={season}";
                            tpl.Append($"{season} —Å–µ–∑–æ–Ω", link, season);
                        }

```

**File:** Online/Controllers/VeoVeo.cs (L97-116)
```csharp
                    else
                    {
                        var episodes = cache.Value.Where(i => i["season"].Value<int>("order") == s);

                        var etpl = new EpisodeTpl(episodes.Count());
                        string sArhc = s.ToString();

                        foreach (var episode in episodes.OrderBy(i => i.Value<int>("order")))
                        {
                            string name = episode.Value<string>("title");
                            string file = episode.Value<string>("m3u8MasterFilePath");

                            if (string.IsNullOrEmpty(file))
                                continue;

                            string stream = HostStreamProxy(init, file, proxy: proxy);
                            etpl.Append(name ?? $"{episode.Value<int>("order")} —Å–µ—Ä–∏—è", title ?? original_title, sArhc, episode.Value<int>("order").ToString(), stream, vast: init.vast);
                        }

                        return rjson ? etpl.ToJson() : etpl.ToHtml();
```

**File:** Shared/Engine/Online/Kodik.cs (L254-282)
```csharp
                    #region –ü–µ—Ä–µ–≤–æ–¥
                    var vtpl = new VoiceTpl();
                    HashSet<string> hash = new HashSet<string>();

                    foreach (var item in results)
                    {
                        string id = item.id;
                        if (string.IsNullOrEmpty(id))
                            continue;

                        string name = item.translation.title ?? "–æ—Ä–∏–≥–∏–Ω–∞–ª";
                        if (hash.Contains(name))
                            continue;

                        if (item.last_season != s)
                        {
                            if (item.seasons == null || !item.seasons.ContainsKey(s.ToString()))
                                continue;
                        }

                        hash.Add(name);

                        if (string.IsNullOrEmpty(kid))
                            kid = id;

                        string link = host + $"lite/kodik?rjson={rjson}&imdb_id={imdb_id}&kinopoisk_id={kinopoisk_id}&title={enc_title}&original_title={enc_original_title}&clarification={clarification}&pick={enc_pick}&s={s}&kid={id}";

                        vtpl.Append(name, kid == id, link);
                    }
```

**File:** Online/Controllers/Lumex.cs (L64-76)
```csharp
                return await InvkSemaphore(init, memKey, async () =>
                {
                    if (!hybridCache.TryGetValue(memKey, out SimilarTpl search))
                    {
                        search = await oninvk.Search(title, original_title, serial, clarification, database);
                        if (search.data?.Count == 0)
                            return OnError("search");

                        hybridCache.Set(memKey, search, cacheTime(40, init: init));
                    }

                    return ContentTo(rjson ? search.ToJson() : search.ToHtml());
                });
```

**File:** Online/Controllers/CDNmovies.cs (L19-21)
```csharp
            var rch = new RchClient(HttpContext, host, init, requestInfo);
            if (rch.IsNotSupport("web", out string rch_error))
                return ShowError(rch_error);
```
